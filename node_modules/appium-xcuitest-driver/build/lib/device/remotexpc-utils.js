"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getRemoteXPCServices = getRemoteXPCServices;
const support_1 = require("appium/support");
const node_path_1 = __importDefault(require("node:path"));
const node_fs_1 = require("node:fs");
/**
 * Cached RemoteXPC Services module
 */
let cachedRemoteXPCServices = null;
/**
 * Module root and version cached at initialization
 */
const { moduleRoot, remoteXpcVersion } = fetchInstallInfo();
/**
 * Get the RemoteXPC Services module dynamically
 *
 * This helper centralizes the import of appium-ios-remotexpc to:
 * - Provide consistent error handling across all services
 * - Give helpful installation instructions when the module is missing
 *
 * @returns The Services export from appium-ios-remotexpc
 * @throws {Error} If the module cannot be imported
 */
async function getRemoteXPCServices() {
    if (cachedRemoteXPCServices) {
        return cachedRemoteXPCServices;
    }
    try {
        const remotexpcModule = await import('appium-ios-remotexpc');
        cachedRemoteXPCServices = remotexpcModule.Services;
        return cachedRemoteXPCServices;
    }
    catch (err) {
        const error = err;
        if (error.message.includes('Cannot find module')) {
            let errorMessage = 'Failed to import appium-ios-remotexpc module. ' +
                'This module is required for iOS 18 and above device operations.';
            if (moduleRoot && remoteXpcVersion) {
                errorMessage +=
                    ' Please install it by running: ' +
                        `cd "${moduleRoot}" && npm install "appium-ios-remotexpc@${remoteXpcVersion}".`;
            }
            errorMessage += ` Original error: ${error.message}`;
            throw new Error(errorMessage);
        }
        throw new Error('Failed to import appium-ios-remotexpc module. ' +
            'This module is required for iOS 18 and above device operations. ' +
            `Original error: ${error.message}`);
    }
}
/**
 * Fetch module root and appium-ios-remotexpc version from package.json
 *
 * @returns Object containing moduleRoot and remoteXpcVersion
 */
function fetchInstallInfo() {
    try {
        const root = support_1.node.getModuleRootSync('appium-xcuitest-driver', __filename);
        if (root) {
            const packageJsonPath = node_path_1.default.join(root, 'package.json');
            const packageJsonContent = (0, node_fs_1.readFileSync)(packageJsonPath, 'utf8');
            if (packageJsonContent) {
                const packageJson = JSON.parse(packageJsonContent);
                return {
                    moduleRoot: root,
                    remoteXpcVersion: packageJson.optionalDependencies?.['appium-ios-remotexpc'],
                };
            }
        }
    }
    catch {
        // Error messages will skip install hints
    }
    return { moduleRoot: undefined, remoteXpcVersion: undefined };
}
//# sourceMappingURL=remotexpc-utils.js.map